Refactor the extension activation code to split on phases.
